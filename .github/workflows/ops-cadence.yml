name: Ops Cadence

on:
  schedule:
    - cron: '0 14 * * 1-5'   # Weekdays 9am ET (14:00 UTC)
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  staleness:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: Check ops/ staleness and create issue if needed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          now=$(date +%s)
          roadmap_age=$(( (now - $(git log -1 --format=%ct -- ops/03-ROADMAP_NOW_NEXT_LATER.md)) / 86400 ))
          arch_age=$(( (now - $(git log -1 --format=%ct -- ops/02-ARCHITECTURE.md)) / 86400 ))
          north_age=$(( (now - $(git log -1 --format=%ct -- ops/00-NORTHSTAR.md)) / 86400 ))
          DOW=$(date +%u)

          body=""

          if [ "$roadmap_age" -gt 5 ]; then
            body+="### ROADMAP — ${roadmap_age} days since last update\n"
            body+="- [ ] Update Now/Next items in \`ops/03-ROADMAP_NOW_NEXT_LATER.md\`\n"
            body+="- [ ] Add 1–3 current focus notes\n\n"
          fi

          if [ "$DOW" = "1" ]; then
            if [ "$arch_age" -gt 14 ]; then
              body+="### ARCHITECTURE — ${arch_age} days since last update\n"
              body+="- [ ] Review \`ops/02-ARCHITECTURE.md\` — any boundary changes?\n\n"
            fi
            if [ "$north_age" -gt 30 ]; then
              body+="### NORTHSTAR — ${north_age} days since last update\n"
              body+="- [ ] Review \`ops/00-NORTHSTAR.md\` — still accurate?\n\n"
            fi
          fi

          if [ -n "$body" ]; then
            existing=$(gh issue list --search "[ops-cadence]" --state open --limit 1 --json number -q '.[0].number')
            if [ -n "$existing" ]; then
              gh issue comment "$existing" --body "$(printf "Staleness check update:\n\n${body}")"
            else
              gh issue create \
                --title "[ops-cadence] Docs need refresh" \
                --body "$(printf "${body}---\n*Auto-generated by ops-cadence workflow. Close when updated.*")"
            fi
          fi
